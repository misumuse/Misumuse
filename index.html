<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>misumuse P2P Co-Listen & Chat</title>
    
    <!-- PWA THEME CONFIGURATION -->
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-web-app-status-bar-style" content="black">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PeerJS Library for P2P connections -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* Custom styles for the responsive, clean UI */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .card {
            background-color: #161b22; /* Slightly lighter dark card */
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.05), 0 4px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid #2f343a;
        }
        .control-button, .playlist-button {
            transition: transform 0.1s ease-in-out, background-color 0.2s, box-shadow 0.2s;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        
        /* Custom track style for range inputs */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #58a6ff;
            cursor: pointer;
            border-radius: 50%;
            margin-top: -6px;
            box-shadow: 0 0 5px #58a6ff;
        }
        input[type="range"] {
            -webkit-appearance: none;
            background: #30363d;
            height: 4px;
            border-radius: 2px;
            width: 100%;
        }
        .track-item {
            transition: background-color 0.2s;
        }
        .track-item:hover:not(.current-track) {
            background-color: #262c35;
        }
        .current-track {
            background-color: #004a6e !important; /* Darker cyan background */
            border: 1px solid #00c3ff;
            box-shadow: 0 0 8px rgba(0, 195, 255, 0.4);
        }

        /* Aspect ratio container for YouTube embed */
        .video-container {
            position: relative;
            width: 100%;
            /* 16:9 Aspect Ratio */
            padding-bottom: 56.25%; 
            border-radius: 0.5rem; 
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Scrollbar styling for chat and playlist */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #161b22;
        }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4">

    <!-- Main Container (Responsive Grid Layout) -->
    <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- 1. Music Player Card (Takes 2/3 width on desktop) -->
        <div class="lg:col-span-2 order-1 lg:order-1">
            <div id="player-card" class="card p-6 md:p-10 w-full rounded-xl text-white">
                
                <!-- Logo Section -->
                <div class="text-center mb-6">
                    <div class="flex justify-center items-center">
                        <svg class="w-8 h-8 mr-2 text-cyan-400" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 21a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM12 17V5m0 0h5c2.21 0 4 1.79 4 4s-1.79 4-4 4h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="text-3xl font-extrabold text-cyan-400">misumuse</span>
                    </div>
                    <p class="text-sm font-light mt-1 text-gray-400">P2P Real-Time Co-Listening</p>
                </div>
                
                <!-- Status/Panel -->
                <div id="status-panel" class="mb-6 border-b border-gray-700 pb-4">
                    <p id="auth-status" class="text-xs text-center text-gray-500 font-bold tracking-wider">
                        STATUS: OFFLINE
                    </p>
                </div>

                <!-- Media Display Area -->
                <div id="media-display-container" class="w-full mx-auto mb-6">
                    
                    <!-- YouTube Player Container (Initially Hidden) -->
                    <div id="youtube-player-container" class="video-container hidden">
                        <div id="youtube-player"></div>
                    </div>

                    <!-- Album Art Placeholder (Initially Visible) -->
                    <div id="audio-display-container" class="w-full h-48 mx-auto bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden border border-gray-600">
                        <svg class="w-20 h-20 text-gray-400 opacity-50" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 21a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM12 17V5m0 0h5c2.21 0 4 1.79 4 4s-1.79 4-4 4h-5" />
                        </svg>
                    </div>

                </div>

                <!-- Track Information -->
                <div class="text-center mb-6 min-h-12">
                    <p id="track-title" class="text-2xl font-bold truncate">No song loaded</p>
                    <p id="track-artist" class="text-md text-gray-400 mt-1">Load a song below</p>
                </div>

                <!-- Progress Bar and Time -->
                <div id="audio-controls-container" class="mb-4">
                    <input type="range" id="seek-bar" min="0" max="100" value="0" class="w-full h-2 cursor-pointer" disabled>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                
                <!-- Controls Row -->
                <div class="flex flex-col sm:flex-row items-center justify-between mb-8">
                    
                    <!-- Volume Control -->
                    <div class="flex items-center space-x-2 w-full sm:w-1/3 mb-4 sm:mb-0 justify-center sm:justify-start">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 3.23v2.06c2.89.81 5 3.53 5 6.71s-2.11 5.9-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM16.5 12c0-2.22-1.2-4.14-3-5.19v10.38c1.8-1.05 3-2.97 3-5.19zM12 5L7 9H3v6h4l5 4V5z"/>
                        </svg>
                        <input type="range" id="volume-slider" min="0" max="100" value="70" class="h-2 cursor-pointer w-24 md:w-32">
                    </div>
                    
                    <!-- Playback Controls (Main Row) -->
                    <div class="flex justify-center items-center space-x-3 sm:space-x-6 w-full sm:w-auto">
                        <button onclick="skipTrack(-1)" class="control-button p-3 rounded-full bg-gray-700 hover:bg-gray-600 text-xl text-cyan-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                        </button>
                        
                        <button onclick="skip(-10)" id="seek-back-btn" class="control-button p-3 rounded-full bg-gray-700 hover:bg-gray-600 text-xl text-cyan-400 hidden sm:inline-block" title="-10s">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 0116 0M3 12h18"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7"></path></svg>
                        </button>

                        <!-- Play/Pause Button -->
                        <button onclick="playPause()" id="play-pause-btn" class="control-button p-4 rounded-full bg-cyan-600 hover:bg-cyan-700 text-2xl shadow-lg shadow-cyan-900/50" disabled>
                            <svg id="play-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z"></path></svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4v16m4-16v16"></path></svg>
                        </button>

                        <button onclick="skip(10)" id="seek-forward-btn" class="control-button p-3 rounded-full bg-gray-700 hover:bg-gray-600 text-xl text-cyan-400 hidden sm:inline-block" title="+10s">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 0116 0M3 12h18"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 19l7-7-7-7M5 19l7-7-7-7"></path></svg>
                        </button>

                        <button onclick="skipTrack(1)" class="control-button p-3 rounded-full bg-gray-700 hover:bg-gray-600 text-xl text-cyan-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 19l7-7-7-7M5 19l7-7-7-7"></path></svg>
                        </button>
                    </div>

                    <!-- Placeholder for other controls if needed -->
                    <div class="w-full sm:w-1/3 hidden sm:block"></div>
                </div>

                <!-- DEDICATED YOUTUBE ERROR DISPLAY & Message Box -->
                <div id="yt-error-display" class="hidden p-3 rounded-lg text-sm mb-4 bg-red-900 border border-red-700 text-red-100">
                    <p class="font-bold mb-1">YouTube Playback Status:</p>
                    <p id="yt-error-message"></p>
                </div>
                <div id="message-box" class="hidden p-3 rounded text-sm mb-4"></div>

                <!-- Music Loading Section -->
                <div class="space-y-4 pt-4 border-t border-gray-700">
                    <h2 class="text-lg font-medium text-gray-300">
                        Load Track 
                        <span class="text-yellow-400 text-sm font-normal ml-2">(MP3 URL / YouTube <span class="text-red-400 font-bold">[BETA]</span> URL)</span>
                    </h2>
                    <input type="text" id="audio-url-input" placeholder="Paste MP3 or YouTube URL here." class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm placeholder-gray-400">
                    <input type="text" id="artist-input" placeholder="Artist/Channel Name (optional)" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm placeholder-gray-400">
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <button onclick="loadFromURL()" class="p-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 transition duration-150 font-semibold shadow-md shadow-emerald-900/50">
                            Load & Play
                        </button>
                        <button onclick="addCurrentToPlaylist()" id="add-to-playlist-btn" class="p-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition duration-150 font-semibold shadow-md shadow-indigo-900/50" disabled>
                            Save to Playlist
                        </button>
                        <button onclick="downloadCurrentTrack()" id="download-btn" class="p-3 rounded-lg bg-yellow-600 hover:bg-yellow-700 transition duration-150 font-semibold shadow-md shadow-yellow-900/50" disabled>
                            Download
                        </button>
                        <label for="local-file-input" class="p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 font-semibold text-center cursor-pointer">
                            Load Local File
                        </label>
                        <input type="file" id="local-file-input" accept="audio/*" class="hidden">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2. P2P Chat and Playlist (Side column on desktop) -->
        <div class="lg:col-span-1 order-3 lg:order-2 space-y-6">

            <!-- P2P Card -->
            <div id="p2p-card" class="card p-6 w-full rounded-xl text-white">
                <h2 class="text-xl font-bold mb-4 text-center text-green-400">P2P Connection Hub</h2>
                
                <!-- Peer ID Section -->
                <div class="bg-gray-800 p-3 rounded-lg mb-4 border border-gray-700">
                    <p class="text-xs font-semibold text-gray-400 mb-1">YOUR PEER ID (Share this):</p>
                    <div class="flex items-center space-x-2">
                        <span id="my-peer-id" class="peer-id-display text-sm md:text-md text-green-400 font-mono truncate">Initializing...</span>
                        <button onclick="copyPeerId()" class="flex-shrink-0 p-1 text-green-400 hover:text-green-200 transition duration-150 rounded-full bg-gray-700" title="Copy ID">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Connection Section -->
                <div class="mb-4">
                    <p class="text-xs font-semibold text-gray-400 mb-2">REMOTE PEER ID:</p>
                    <div class="flex space-x-2">
                        <input type="text" id="remote-peer-id" placeholder="Enter peer ID to connect" class="flex-1 p-2 rounded bg-gray-700 border border-gray-600 text-sm placeholder-gray-400 focus:ring-green-500 focus:border-green-500">
                        <button onclick="connectToPeer()" id="connect-btn" class="p-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition duration-150 shadow-md shadow-green-900/50" disabled>
                            Connect
                        </button>
                    </div>
                    <p id="connection-status" class="text-center text-sm mt-2 font-medium text-red-400">Status: Disconnected</p>
                </div>
                
                <!-- Chat Window -->
                <div class="space-y-3 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-medium text-gray-300 flex items-center">
                        P2P Chat 
                        <span id="sync-status" class="ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-yellow-900 text-yellow-300 hidden">SYNCING</span>
                    </h3>
                    <div id="messages" class="custom-scrollbar h-40 overflow-y-auto p-3 border border-gray-700 rounded-lg bg-gray-900 space-y-2">
                        <p class="text-gray-500 text-xs italic">Connect to a peer to start chatting.</p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="message-input" placeholder="Send a message..." class="flex-1 p-2 rounded bg-gray-700 border border-gray-600 text-sm" disabled>
                        <button onclick="sendMessage()" id="send-btn" class="p-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition duration-150" disabled>
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Playlist Manager -->
            <div class="card p-6 w-full rounded-xl text-white">
                <h2 class="text-xl font-bold mb-4 text-center text-indigo-400">
                    My Private Playlist
                </h2>
                
                <!-- Import/Export Controls (Metadata Sharing) -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="exportPlaylist()" class="playlist-button flex-1 p-3 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm font-semibold">
                        Export .misu
                    </button>
                    <label for="import-file-input" class="playlist-button flex-1 text-center cursor-pointer p-3 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm font-semibold">
                        Import .misu
                    </label>
                    <input type="file" id="import-file-input" accept=".misu, .txt" class="hidden">
                </div>

                <!-- Playlist List -->
                <ul id="playlist-ul" class="custom-scrollbar space-y-2 max-h-96 overflow-y-auto pr-2">
                    <li class="p-3 bg-gray-700 rounded text-sm text-gray-400">Playlist is loading...</li>
                </ul>
            </div>

        </div>
    </div>

    <!-- The actual HTML5 Audio Element (hidden) -->
    <audio id="music-player"></audio>
    
    <!-- YouTube Iframe Player API Script -->
    <script async src="https://www.youtube.com/iframe_api"></script>
    
    <!-- Visual Representation of the P2P Architecture -->
    <!-- This helps the user understand why PeerID is needed for direct connections -->
    <!--  -->


    <script>
        // --- Global App State ---
        const LOCAL_STORAGE_KEY = 'misumuse_playlist';
        let playlistData = []; 
        let currentTrackInfo = null; 
        let mediaType = 'AUDIO'; 
        let isSeeking = false;
        let isLoadingTrack = false;
        
        // --- PeerJS State ---
        let peer = null;
        let connection = null;
        const PEER_SERVER_HOST = '0.peerjs.com'; 
        const PEER_SERVER_PORT = 443;
        const PEER_SERVER_PATH = '/';
        const PEER_SERVER_SECURE = true;
        let isP2PListener = false; // Flag to prevent sync loop

        // --- Global HTML Element References ---
        const audio = document.getElementById('music-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const seekBar = document.getElementById('seek-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const titleEl = document.getElementById('track-title');
        const artistEl = document.getElementById('track-artist');
   
